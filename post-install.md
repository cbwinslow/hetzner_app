Hetzner Ubuntu Post-Installation Scripts for Dotfiles - Comprehensive PlanThis plan outlines a modular approach to your server setup, breaking the current monolithic script into several focused scripts. Each script will handle a specific aspect of the server configuration, making them easier to manage, update, and apply selectively.Proposed Script List:01_system_essentials.shSummary: Handles core system updates, essential package installations, and basic user/SSH key setup. This script is foundational and should typically be run first.Topics/Functions Covered:System apt update and apt upgrade.apt autoremove.Ensuring openssh-server is installed.SSH key permissions and ownership for the non-root user (/home/$USERNAME/.ssh).Installation of build-essential, git, curl, wget, htop, nano, vim, tmux, unzip, zip.02_ssh_hardening.shSummary: Focuses solely on securing the SSH daemon configuration. This should be run after 01_system_essentials.sh to ensure SSH is functional before hardening.Topics/Functions Covered:Disabling password authentication.Setting PermitRootLogin to prohibit-password.Disabling X11 forwarding.Disabling GSSAPI authentication.Restarting the ssh service.Includes a backup of sshd_config before modifications.03_firewall_setup.shSummary: Configures the Uncomplicated Firewall (UFW) to allow necessary services and enables it.Topics/Functions Covered:Installation of ufw if not present.Allowing OpenSSH (port 22).Allowing HTTP (port 80).Allowing HTTPS (port 443).Enabling UFW.04_web_server_caddy.shSummary: Installs and configures the Caddy web server, including support for plugins. Caddy automatically handles HTTPS, which simplifies setup.Topics/Functions Covered:Adding Caddy's APT repository.Installation of Caddy.Basic Caddyfile configuration for a web root.(Conceptual: Mentioning how to install Caddy with specific plugins, often requires building from source or using a custom Docker image).Starting and enabling caddy service.Folder Hardening: Setting secure permissions for web-facing folders (/var/www/html).05_php_setup.shSummary: Installs PHP-FPM and common PHP extensions, and applies basic PHP hardening.Topics/Functions Covered:Detection and installation of the latest PHP-FPM version and common extensions.Starting and enabling php-fpm service.Setting web root permissions (/var/www/html) and ownership for the non-root user and www-data group.Adding the non-root user to the www-data group.Disabling expose_php.Disabling display_errors and enabling log_errors.Disabling dangerous PHP functions (disable_functions).Setting open_basedir.Restarting php-fpm service.06_database_postgresql.shSummary: Installs and enables the PostgreSQL database server, preferred over MariaDB.Topics/Functions Covered:Installation of postgresql and postgresql-contrib.Starting and enabling postgresql service.Creating a default database user and database.(Conceptual: Mentioning pg_hba.conf for access control).07_nodejs_install.shSummary: Adds the NodeSource repository and installs Node.js LTS.Topics/Functions Covered:Adding NodeSource APT repository.Installation of nodejs.08_security_enhancements.shSummary: Configures automatic security updates and installs Fail2Ban.Topics/Functions Covered:Installation and non-interactive configuration of unattended-upgrades.Configuration of automatic package removal for unattended-upgrades.Installation of fail2ban.Starting and enabling fail2ban service.Copying jail.conf to jail.local if it doesn't exist.09_system_tuning.shSummary: Applies basic kernel hardening settings via sysctl and ensures time synchronization.Topics/Functions Covered:Ensuring time synchronization (preferring systemd-timesyncd or installing ntp).Applying various sysctl security settings (e.g., rp_filter, tcp_syncookies, ip_forward, sysrq, kptr_restrict, dmesg_restrict).10_antivirus_setup.shSummary: Installs and configures an open-source antivirus solution (ClamAV) for basic server-side scanning.Topics/Functions Covered:Installation of clamav and clamav-daemon.Initial update of virus definitions (freshclam).Enabling and starting clamav-daemon service.Setting up a basic cron job for daily virus definition updates.11_ids_snort_setup.shSummary: Installs and provides a detailed initial setup for Snort, an intrusion detection system.Topics/Functions Covered:Installation of Snort and its dependencies.Initial configuration of Snort (network interface, rule sets).Downloading and updating Snort rules.Setting up Snort to run in IDS mode.(Conceptual: Mentioning integration with logging systems).12_docker_setup.shSummary: Installs Docker and Docker Compose, essential for containerizing most of your AI/LLM and observability tools.Topics/Functions Covered:Adding Docker's official GPG key and repository.Installation of docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin.Adding the non-root user to the docker group.Starting and enabling Docker service.13_message_queue_rabbitmq.shSummary: Installs and configures RabbitMQ as a message broker, essential for decoupling services and handling asynchronous telemetry/logging.Topics/Functions Covered:Adding RabbitMQ APT repository.Installation of rabbitmq-server.Enabling and starting rabbitmq-server service.Enabling common RabbitMQ plugins (e.g., management plugin for web UI).Creating a RabbitMQ user and virtual host for applications.14_metrics_prometheus_netdata.shSummary: Sets up Prometheus for metric collection and Netdata for real-time system monitoring.Topics/Functions Covered:Prometheus: Installation of Prometheus, node_exporter for system metrics, and basic configuration to scrape node_exporter.Netdata: Installation of Netdata and ensuring its service is running.15_log_aggregation_loki_promtail.shSummary: Installs Grafana Loki for log aggregation and Promtail as its agent for collecting logs from the server.Topics/Functions Covered:Installation of Grafana (for visualization).Installation of Loki.Installation and configuration of Promtail to collect system logs and forward them to Loki.Setting up systemd services for Loki and Promtail.16_log_analysis_opensearch.shSummary: Installs OpenSearch (a fork of Elasticsearch) for advanced log analysis, full-text search, and structured data querying, including its dashboards.Topics/Functions Covered:Adding OpenSearch APT repository.Installation of OpenSearch and OpenSearch Dashboards.Basic configuration of OpenSearch (e.g., cluster name, network host).Setting up OpenSearch security (initial admin user, TLS).Enabling and starting OpenSearch and OpenSearch Dashboards services.17_reverse_proxy_traefik_cloudflare.shSummary: Installs Traefik as a dynamic reverse proxy and load balancer, and configures Cloudflare DNS and cloudflared for secure tunnels.Topics/Functions Covered:Installation of Traefik (Docker-based recommended for dynamic config).Basic Traefik configuration (entrypoints, Docker provider).Installation of cloudflared (Cloudflare Tunnel).(Conceptual: Creating Cloudflare Tunnel, DNS records).Setting up Traefik to handle routing for web-facing applications.18_ai_llm_rag_infra_setup.shSummary: Sets up the core infrastructure for AI/LLM/RAG components, focusing on Docker-based deployments for flexibility.Topics/Functions Covered:Vector Databases: Installation of Qdrant (preferred) or Milvus (alternative) via Docker Compose.LLM Inference Server: Installation of LocalAI or llama.cpp (via Docker Compose) for local LLM inference.Chatbot UI: Installation of OpenWebUI (via Docker Compose) for a web-based LLM interface.Agent-Zero: (Conceptual: Guidance on deploying Agent-Zero, likely via Docker/Python environment).Python Environment: Ensuring python3-venv is installed for isolated Python environments for AI libraries.Guidance for other AI tools: Acknowledging the extensive list (adk-python, agent-cli, A2A by google, anythingLLM, Archon, OpenHands dev server, botpress, continue, crawlee, deep-research-agent, fullstack-chat-server, gpt4all, haystack, hakrawler, graphrag, khoj, kilocode, llama_index, litellm, localagi, localrecall, metagpt, langchains, landgraph, mcp server). Most of these are Python libraries or applications best deployed within Docker containers, often using Docker Compose files that you would manage separately. This script focuses on the underlying platforms.19_hashicorp_essentials.shSummary: Installs essential HashiCorp tools that provide fundamental capabilities for secrets management and service discovery.Topics/Functions Covered:Installation of HashiCorp GPG key and repository.Installation of Vault (for secrets management).Installation of Consul (for service discovery and health checking).Basic configuration for Vault (dev mode for initial setup, or production hardening guidance).Basic configuration for Consul.Enabling and starting Vault and Consul services.General Considerations for all scripts:Idempotency: Each script is designed to be idempotent, meaning it can be run multiple times without causing errors or unintended side effects.Logging: Retain the log_info, log_warn, log_success, and log_error functions for consistent output.ensure_line function: The ensure_line function will be included in each script that modifies configuration files, making it easy to manage line insertions and replacements idempotently.Dependencies: Each script will assume that the previous, logically dependent scripts have been run.set -e: Keep set -e at the beginning of each script to ensure that the script exits immediately if any command fails.USERNAME variable: The USERNAME variable will be a global variable at the top of each script that requires it, making it easy to customize.Dotfiles Integration: These scripts can be placed in a bin directory within your dotfiles and symlinked to your system's PATH, or simply executed directly.
